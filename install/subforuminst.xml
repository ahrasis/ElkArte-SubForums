<?xml version="1.0"?>
<!DOCTYPE package-info SYSTEM "http://www.elkarte.net/site/package-info">
<modification xmlns="http://www.elkarte.net/site/package-info" xmlns:elk="http://www.elkarte.net/">
	<license><![CDATA[
/**
 *
 * This software is a derived product, based on:
 * @name     	PortaMX-SubForums
 * @copyright	PortaMx Corp. http://portamx.com (SMF Version)
 *
 * This software is converted to ElkArte:
 * @convertor  	ahrasis http://elkarte.ahrasis.com (ElkArte Version)
 * @license 	BSD http://opensource.org/licenses/BSD-3-Clause
 * @name     	SFA: Sub Forums Addon
 *
 */
]]></license>

<file name="BOARDDIR/index.php">
	<operation>
		<search position="after"><![CDATA[
		// I see you!
		writeLog();
]]></search>
		<add><![CDATA[
		// call the subforums check access.
		SubforumsAllocator('isAllowed');
]]></add>
	</operation>
</file>


<file name="SOURCEDIR/Load.php">
	<operation>
		<search position="before"><![CDATA[
	}
	else
		$id_theme = (int) $id_theme;
]]></search>
		<add><![CDATA[
	// call subforums theme change
	$id_theme = SubforumsAllocator('LoadTheme', $id_theme);
]]></add>
	</operation>

	<operation>
		<search position="after"><![CDATA[
	// Detect the browser. This is separated out because it's also used in attachment downloads
	detectBrowser();
]]></search>
		<add><![CDATA[
	// call subforum context
	SubforumsAllocator('getContext');
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
		// Default language directories to try.
		$language_directories = array(
			$settings['default_theme_dir'] . '/languages',
			$settings['actual_theme_dir'] . '/languages',
		);
]]></search>
		<add><![CDATA[
		// Default language directories to try.
		if(!isset($settings['actual_theme_dir']))
			$settings['actual_theme_dir'] = $settings['default_theme_dir'];

		$language_directories = array(
			$settings['default_theme_dir'] . '/languages',
			$settings['actual_theme_dir'] . '/languages',
		);
]]></add>
	</operation>
</file>

<file name="CONTROLLERDIR/Auth.controller.php">
	<operation>
		<search position="replace"><![CDATA[
			$context['login_errors'] = array($txt['no_password']);
			return;
]]></search>
		<add><![CDATA[
			$_SESSION['subforums_failed_login'] = true;
			$context['login_errors'] = array($txt['no_password']);
			return;
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
			$context['login_errors'] = array($txt['username_no_exist']);
			return;
]]></search>
		<add><![CDATA[
			$_SESSION['subforums_failed_login'] = true;
			$context['login_errors'] = array($txt['username_no_exist']);
			return;
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
			$context['login_errors'] = array($txt['login_hash_error']);
			$context['disable_login_hashing'] = true;
]]></search>
		<add><![CDATA[
			$_SESSION['subforums_failed_login'] = true;
			$context['login_errors'] = array($txt['login_hash_error']);
			$context['disable_login_hashing'] = true;
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
				validatePasswordFlood($user_settings['id_member'], $user_settings['passwd_flood']);

				$_SESSION['failed_login'] = isset($_SESSION['failed_login']) ? ($_SESSION['failed_login'] + 1) : 1;
]]></search>
		<add><![CDATA[
				validatePasswordFlood($user_settings['id_member'], $user_settings['passwd_flood']);

				$_SESSION['failed_login'] = isset($_SESSION['failed_login']) ? ($_SESSION['failed_login'] + 1) : 1;
				$_SESSION['subforums_failed_login'] = true;
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
					$context['disable_login_hashing'] = true;
					$context['login_errors'] = array($txt['incorrect_password']);
]]></search>
		<add><![CDATA[
					$_SESSION['subforums_failed_login'] = true;
					$context['disable_login_hashing'] = true;
					$context['login_errors'] = array($txt['incorrect_password']);
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
				// They've messed up again - keep a count to see if they need a hand.
				$_SESSION['failed_login'] = isset($_SESSION['failed_login']) ? ($_SESSION['failed_login'] + 1) : 1;
]]></search>
		<add><![CDATA[
				// They've messed up again - keep a count to see if they need a hand.
				$_SESSION['failed_login'] = isset($_SESSION['failed_login']) ? ($_SESSION['failed_login'] + 1) : 1;
				$_SESSION['subforums_failed_login'] = true;
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
					// Log an error so we know that it didn't go well in the error log.
					log_error($txt['incorrect_password'] . ' - <span class="remove">' . $user_settings['member_name'] . '</span>', 'user');
]]></search>
		<add><![CDATA[
					// Log an error so we know that it didn't go well in the error log.
					log_error($txt['incorrect_password'] . ' - <span class="remove">' . $user_settings['member_name'] . '</span>', 'user');
					$_SESSION['subforums_failed_login'] = true;
]]></add>
	</operation>
</file>


<file name="CONTROLLERDIR/News.controller.php">
	<operation>
		<search position="before"><![CDATA[
		$limit = empty($modSettings['xmlnews_limit']) ? 5 : min($modSettings['xmlnews_limit'], 255);
		$this->_limit = empty($_GET['limit']) || (int) $_GET['limit'] < 1 ? $limit : min((int) $_GET['limit'], $limit);
]]></search>
		<add><![CDATA[
		$feed_titleurl = SubforumsAllocator('getMemberurl', $scripturl);
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
				$feed_title = ' - ' . strip_tags($feed_title);
]]></search>
		<add><![CDATA[
				$feed_titleurl = SubforumsAllocator('getScripturl', array('cats', $_REQUEST['c'][0], $scripturl));
				$feed_title = ' - ' . strip_tags($feed_title);
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
				if ($num_boards == 1)
					$feed_title = ' - ' . strip_tags($row['name']);
]]></search>
		<add><![CDATA[
				if ($num_boards == 1)
				{
					$feed_title = ' - ' . strip_tags($row['name']);
					$feed_titleurl = SubforumsAllocator('getScripturl', array('boards', $row['id_board'], $scripturl));
				}
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
	global $modSettings, $context, $scripturl;

	if (substr($val, 0, strlen($scripturl)) != $scripturl)
		return $val;

	call_integration_hook('integrate_fix_url', array(&$val));
]]></search>
		<add><![CDATA[
	global $modSettings, $context, $scripturl, $boardurl;

	$base = parse_url($val);
	if(isset($base['scheme']) && isset($base['host']) && $base['host'] == SubforumsAllocator('isOwnurl', $base['host']))
	{
		$saved = $boardurl;
		$tmp = parse_url($boardurl);
		$boardurl = str_replace($tmp['host'], $base['host'], $boardurl);

		call_integration_hook('integrate_fix_url', array(&$val));

		$boardurl = $saved;
	}
	else
	{
		if (substr($val, 0, strlen($scripturl)) != $scripturl)
			return $val;

		call_integration_hook('integrate_fix_url', array(&$val));
	}
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
			$feed_title = ' - ' . strip_tags($board_info['name']);

			$this->_query_this_board = 'b.id_board = ' . $board;
]]></search>
		<add><![CDATA[
			$feed_title = ' - ' . strip_tags($board_info['name']);
			$feed_titleurl = SubforumsAllocator('getScripturl', array('boards', $board, $scripturl));

			$this->_query_this_board = 'b.id_board = ' . $board;
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
		if (!allowedTo('view_mlist'))
			return array();
]]></search>
		<add><![CDATA[
		if (!allowedTo('view_mlist'))
			return array();

		$url = SubforumsAllocator('getMemberurl', $scripturl);
		if(empty($url))
			return array();

		$base_scripturl = $scripturl;
		$scripturl = $url;
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
					'link' => $scripturl . '?action=profile;u=' . $member['id_member']
				);
		}

		return $data;
	}
]]></search>
		<add><![CDATA[
					'link' => $scripturl . '?action=profile;u=' . $member['id_member']
				);
		}
		$db->free_result($result);
		
		return $data;
	}
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
		// Prepare it for the feed in the format chosen (rss, atom, etc)
		$data = array();
		foreach ($results as $row)
		{
]]></search>
		<add><![CDATA[
		// Prepare it for the feed in the format chosen (rss, atom, etc)
		$base_scripturl = $scripturl;
		$data = array();
		foreach ($results as $row)
		{
			$newurl = SubforumsAllocator('getScripturl', array('boards', $row['id_board'], $base_scripturl));
			if(!empty($newurl))
			{
				$scripturl = $newurl;
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
						'link' => $scripturl . '?board=' . $row['id_board'] . '.0',
					),
					'link' => $scripturl . '?topic=' . $row['id_topic'] . '.0',
				);
			}
		}
]]></search>
		<add><![CDATA[
						'link' => $scripturl . '?board=' . $row['id_board'] . '.0',
					),
					'link' => $scripturl . '?topic=' . $row['id_topic'] . '.0',
				);
			}
		}
		$scripturl = $base_scripturl;
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
		// Loop on the results and prepare them in the format requested
		$data = array();
		foreach ($results as $row)
		{
]]></search>
		<add><![CDATA[
		// Loop on the results and prepare them in the format requested
		$base_scripturl = $scripturl;
		$data = array();
		foreach ($results as $row)
		{
			$newurl = SubforumsAllocator('getScripturl', array('boards', $row['id_board'], $base_scripturl));
			if(!empty($newurl))
			{
				$scripturl = $newurl;
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
					'link' => $scripturl . '?topic=' . $row['id_topic'] . '.msg' . $row['id_msg'] . '#msg' . $row['id_msg']
				);
			}
		}
]]></search>
		<add><![CDATA[
					'link' => $scripturl . '?topic=' . $row['id_topic'] . '.msg' . $row['id_msg'] . '#msg' . $row['id_msg']
				);
			}
		}
		$scripturl = $base_scripturl;
]]></add>
	</operation>

	<operation>
		<search position="before"><![CDATA[
		// Load the member's contextual information!
		if (!loadMemberContext($uid) || !allowedTo('profile_view_any'))
			return array();
]]></search>
		<add><![CDATA[
		$url = SubforumsAllocator('getMemberurl', $scripturl);
		if(empty($url))
			return array();

		$base_scripturl = $scripturl;
		$scripturl = $url;
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
		// Save some memory.
		unset($profile, $memberContext[$uid]);

		return $data;
	}
]]></search>
		<add><![CDATA[
		// Save some memory.
		unset($profile, $memberContext[$uid]);
		$scripturl = $base_scripturl;

		return $data;
	}
]]></add>
	</operation>
</file>

<file name="SUBSDIR/Profile.subs.php">
	<operation>
		<search position="replace"><![CDATA[
	$request = $db->query('', '
		SELECT COUNT(*)
		FROM {db_prefix}topics AS t' . ($user_info['query_see_board'] == '1=1' ? '' : '
			INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board AND {query_see_board})') . '
		WHERE t.id_member_started = {int:current_member}' . (!empty($board) ? '
]]></search>
		<add><![CDATA[
	// SubForums
	$request = $db->query('', '
		SELECT COUNT(*)
		FROM {db_prefix}topics AS t' . ($user_info['query_see_board'] == '1=1' ? '' : '
			INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board AND {query_see_board})') . '
			WHERE t.id_member_started = {int:current_member}' . ($user_info['query_see_board'] == '1=1' ? '{subforums_see_board:t-id_board}' : '') . (!empty($board) ? '
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
	$request = $db->query('', '
		SELECT COUNT(*)
		FROM {db_prefix}messages AS m' . ($user_info['query_see_board'] == '1=1' ? '' : '
			INNER JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board AND {query_see_board})') . '
		WHERE m.id_member = {int:current_member}' . (!empty($board) ? '
]]></search>
		<add><![CDATA[
	// SubForums
	$request = $db->query('', '
		SELECT COUNT(*)
		FROM {db_prefix}messages AS m' . ($user_info['query_see_board'] == '1=1' ? '' : '
			INNER JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board AND {query_see_board})') . '
		WHERE m.id_member = {int:current_member}' . ($user_info['query_see_board'] == '1=1' ? '{subforums_see_board:m-id_board}' : '') . (!empty($board) ? '
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
	$request = $db->query('', '
		SELECT MIN(id_msg), MAX(id_msg)
		FROM {db_prefix}messages AS m
		WHERE m.id_member = {int:current_member}' . (!empty($board) ? '
]]></search>
		<add><![CDATA[
	// SubForums
	$request = $db->query('', '
		SELECT MIN(id_msg), MAX(id_msg)
		FROM {db_prefix}messages AS m
		WHERE m.id_member = {int:current_member}{subforums_see_board:m-id_board}' . (!empty($board) ? '
]]></add>
	</operation>
</file>

<file name="CONTROLLERDIR/ProfileInfo.controller.php">
	<operation>
		<search position="before"><![CDATA[
		$context['time_logged_in'] = ($timeDays > 0 ? $timeDays . $txt['totalTimeLogged2'] : '') . ($timeHours > 0 ? $timeHours . $txt['totalTimeLogged3'] : '') . floor(($user_profile[$memID]['total_time_logged_in'] % 3600) / 60) . $txt['totalTimeLogged4'];
		$context['num_posts'] = comma_format($user_profile[$memID]['posts']);
]]></search>
		<add><![CDATA[
		// SubForums
		if(isset($modSettings['subforums'][$_SERVER['SERVER_NAME']]))
		{
			$result = $db->query('', '
				SELECT COUNT(id_msg)
				FROM {db_prefix}messages
				WHERE id_member = {int:id_mem}{subforums_see_board:id_board}',
				array('id_mem' => $memID)
			);
			list($tmp) = $db->fetch_row($result);
			$db->free_result($request);
			$context['num_posts'] = comma_format($tmp);
		}
]]></add>
	</operation>
</file>

<file name="SUBSDIR/Post.subs.php">
	<operation>
		<search position="replace"><![CDATA[
		WHERE {query_wanna_see_board}' . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
			AND b.id_board != {int:recycle_board}' : '') . '
]]></search>
		<add><![CDATA[
		WHERE {query_wanna_see_board}' . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
			AND b.id_board != {int:recycle_board}' : '') . '{subforums_see_board:id_board}',
]]></add>
	</operation>
</file>


<file name="CONTROLLERDIR/Recent.controller.php">
	<operation>
		<search position="before"><![CDATA[
				$query_parameters['max_id_msg'] = max(0, $modSettings['maxMsgID'] - 600 - $_REQUEST['start'] * 10);
			}

			$context['page_index'] = constructPageIndex($scripturl . '?action=recent;board=' . $board . '.%1$d', $_REQUEST['start'], min(100, $board_data[$board]['num_posts']), 10, true);
		}
		// All the recent posts across boards and categories it is then
		else
		{
]]></search>
		<add><![CDATA[
			// SubForums
			if(isset($modSettings['subforums'][$_SERVER['SERVER_NAME']]))
			{
				$request = $db->query('', '
					SELECT IFNULL(COUNT(id_msg),0), IFNULL(SUM(id_msg),0)
					FROM {db_prefix}messages
					WHERE 1=1{subforums_see_board:id_board}',
					array()
				);
				list($recent_total_posts, $recent_maxMsgID) = $db->fetch_row($request);
				$db->free_result($result);
				if(!empty($recent_total_posts))
					$recent_maxMsgID = intval($recent_maxMsgID / $recent_total_posts);
			}
			else
			{
				$recent_total_posts = $modSettings['totalMessages'];
				$recent_maxMsgID = $modSettings['maxMsgID'];
			}
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
			$query_parameters['max_id_msg'] = max(0, $modSettings['maxMsgID'] - 100 - $_REQUEST['start'] * 6);
			$query_parameters['recycle_board'] = $modSettings['recycle_board'];

			// Set up the pageindex
			require_once(SUBSDIR . '/Boards.subs.php');
			$context['page_index'] = constructPageIndex($scripturl . '?action=recent', $_REQUEST['start'], min(100, sumRecentPosts()), 10, false);
]]></search>
		<add><![CDATA[
			// SubForums
			$query_parameters['max_id_msg'] = max(0, $recent_maxMsgID - 100 - $_REQUEST['start'] * 6);
			$query_parameters['recycle_board'] = $modSettings['recycle_board'];

			// Set up the pageindex
			require_once(SUBSDIR . '/Boards.subs.php');
			$context['page_index'] = constructPageIndex($scripturl . '?action=recent', $_REQUEST['start'], min(100, $recent_total_posts), 10, false);
]]></add>
	</operation>

	<operation error="ignore">
		<search position="replace"><![CDATA[
		$request = $db->query('', '
			SELECT b.id_board
			FROM {db_prefix}boards AS b
			WHERE ' . $user_info[$see_board] . '
]]></search>
		<add><![CDATA[
		// SubForums
		$request = $db->query('', '
			SELECT b.id_board
			FROM {db_prefix}boards AS b
			WHERE {' . $see_board . '}
]]></add>
	</operation>

	<operation error="ignore">
		<search position="replace"><![CDATA[
		$request = $db->query('', '
			SELECT b.id_board
			FROM {db_prefix}boards AS b
			WHERE ' . $user_info[$see_board] . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
]]></search>
		<add><![CDATA[
		// SubForums
		$request = $db->query('', '
			SELECT b.id_board
			FROM {db_prefix}boards AS b
			WHERE {' . $see_board .'}'. (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
]]></add>
	</operation>
</file>


<file name="CONTROLLERDIR/Search.controller.php">
	<operation>
		<search position="replace"><![CDATA[
			$search_params['brd'] = array_keys(fetchBoardsInfo(array('boards' => $query_boards), array('include_recycle' => false, 'include_redirects' => false, 'wanna_see_board' => empty($search_params['advanced']))));
]]></search>
		<add><![CDATA[
		// SubForums
			$search_params['brd'] = array_keys(fetchBoardsInfo(array('boards' => $see_board), array('include_recycle' => false, 'include_redirects' => false, 'wanna_see_board' => empty($search_params['advanced']))));
]]></add>
	</operation>
</file>


<file name="CONTROLLERDIR/Stats.controller.php">
	<operation>
		<search position="before"><![CDATA[
		$averages = getAverages();
]]></search>
		<add><![CDATA[
		// SubForums
		if(isset($modSettings['subforums'][$_SERVER['SERVER_NAME']]))
		{
			$context['num_posts'] = comma_format($modSettings['subforums'][$_SERVER['SERVER_NAME']]['total_posts']);
			$context['num_topics'] = comma_format($modSettings['subforums'][$_SERVER['SERVER_NAME']]['total_topics']);
		}
		else
		{
			$context['num_posts'] = comma_format($modSettings['totalMessages']);
			$context['num_topics'] = comma_format($modSettings['totalTopics']);
		}
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
			'total_posts' => comma_format($modSettings['totalMessages']),
			'total_topics' => comma_format($modSettings['totalTopics']),
			'total_cats' => comma_format(numCategories()),
]]></search>
		<add><![CDATA[
			// SubForums
			// 'total_posts' => comma_format($modSettings['totalMessages']),
			// 'total_topics' => comma_format($modSettings['totalTopics']),
			'total_cats' => comma_format(numCategories()),
]]></add>
	</operation>
</file>

<file name="SUBSDIR/Stats.subs.php">
	<operation>
		<search position="replace"><![CDATA[
	$result = $db->query('distinct_poll_votes', '
		SELECT COUNT(DISTINCT id_poll)
		FROM {db_prefix}log_polls
		WHERE id_member = {int:current_member}',
]]></search>
		<add><![CDATA[
	// SubForums
	$result = $db->query('distinct_poll_votes', '
		SELECT COUNT(DISTINCT id_poll)
		FROM {db_prefix}log_polls AS p
			LEFT JOIN {db_prefix}topics as t ON (p.id_poll = t.id_poll)
		WHERE id_member = {int:current_member}{subforums_see_board:t-id_board}',
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
	$result = $db->query('', '
		SELECT COUNT(*)
		FROM {db_prefix}topics
		WHERE id_member_started = {int:current_member}' . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
			AND id_board != {int:recycle_board}' : '') . '
			AND id_poll != {int:no_poll}',
]]></search>
		<add><![CDATA[
	// SubForums
	$result = $db->query('', '
		SELECT COUNT(*)
		FROM {db_prefix}topics
		WHERE id_member_started = {int:current_member}' . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
			AND id_board != {int:recycle_board}' : '') . '
			AND id_poll != {int:no_poll}{subforums_see_board:id_board}',
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
	$result = $db->query('user_activity_by_time', '
		SELECT
			HOUR(FROM_UNIXTIME(poster_time + {int:time_offset})) AS hour,
			COUNT(*) AS post_count
		FROM {db_prefix}messages
		WHERE id_member = {int:current_member}' . ($modSettings['totalMessages'] > 100000 ? '
			AND id_topic > {int:top_ten_thousand_topics}' : '') . '
]]></search>
		<add><![CDATA[
	// SubForums
	$result = $db->query('user_activity_by_time', '
		SELECT
			HOUR(FROM_UNIXTIME(poster_time + {int:time_offset})) AS hour,
			COUNT(*) AS post_count
		FROM {db_prefix}messages
		WHERE id_member = {int:current_member}' . ($modSettings['totalMessages'] > 100000 ? '
			AND id_topic > {int:top_ten_thousand_topics}' : '') . '{subforums_see_board:id_board}
]]></add>
	</operation>

	<operation error="ignore">
		<search position="replace"><![CDATA[
	$result = $db->query('', '
		SELECT COUNT(*)
		FROM {db_prefix}boards AS b
		WHERE b.redirect = {string:blank_redirect}',
]]></search>
		<add><![CDATA[
	// SubForums
	$result = $db->query('', '
		SELECT COUNT(*)
		FROM {db_prefix}boards AS b
		WHERE b.redirect = {string:blank_redirect}{subforums_see_board:b-id_board}',
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
	$result = $db->query('', '
		SELECT COUNT(*)
		FROM {db_prefix}categories',
		array(
		)
	);
]]></search>
		<add><![CDATA[
	// SubForums
	$result = $db->query('', '
		SELECT COUNT(*)
		FROM {db_prefix}categories'. (isset($modSettings['subforums'][$_SERVER['SERVER_NAME']]) ? '
		WHERE FIND_IN_SET(c.id_cat, {string:cats}) != 0' : ''),
		array(
			'cats' => isset($modSettings['subforums'][$_SERVER['SERVER_NAME']]) ? $modSettings['subforums'][$_SERVER['SERVER_NAME']]['cats'] : ''
		)
	);
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
	$members_result = $db->query('', '
		SELECT id_member, real_name, posts
		FROM {db_prefix}members
		WHERE posts > {int:no_posts}
		ORDER BY posts DESC
		LIMIT {int:limit_posts}',
		array(
			'no_posts' => 0,
			'limit_posts' => $limit,
		)
	);
]]></search>
		<add><![CDATA[
	// SubForums
	if(isset($modSettings['subforums'][$_SERVER['SERVER_NAME']]))
		$members_result = $db->query('', '
			SELECT m.id_member, u.real_name, COUNT(m.id_msg) AS posts
			FROM {db_prefix}messages AS m
			LEFT JOIN {db_prefix}members AS u ON (u.id_member = m.id_member)
			WHERE posts > 0{subforums_see_board:m-id_board}
			GROUP BY m.id_member, u.real_name
			ORDER BY posts DESC
			LIMIT {int:limit_posts}',
			array(
				'no_posts' => 0,
				'limit_posts' => $limit,
				'guest' => $txt['guest_title']
			)
		);
	else
		$members_result = $db->query('', '
			SELECT id_member, real_name, posts
			FROM {db_prefix}members
			WHERE posts > {int:no_posts}
			ORDER BY posts DESC
			LIMIT {int:limit_posts}',
			array(
				'no_posts' => 0,
				'limit_posts' => $limit,
				'guest' => $txt['guest_title']
			)
		);
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
	$boards_result = $db->query('', '
		SELECT b.id_board, b.name, b.num_posts, b.num_topics' . ($read_status ? ',' . (!$user_info['is_guest'] ? ' 1 AS is_read' : '
			(IFNULL(lb.id_msg, 0) >= b.id_last_msg) AS is_read') : '') . '
		FROM {db_prefix}boards AS b' . ($read_status ? '
			LEFT JOIN {db_prefix}log_boards AS lb ON (lb.id_board = b.id_board AND lb.id_member = {int:current_member})' : '') . '
		WHERE {query_see_board}' . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
			AND b.id_board != {int:recycle_board}' : '') . '
			AND b.redirect = {string:blank_redirect}
		ORDER BY num_posts DESC
		LIMIT {int:limit_boards}',
		array(
			'recycle_board' => $modSettings['recycle_board'],
			'blank_redirect' => '',
			'limit_boards' => $limit,
			'current_member' => $user_info['id'],
		)
	);
]]></search>
		<add><![CDATA[
	// SubForums
	$boards_result = $db->query('', '
		SELECT b.id_board, b.name, b.num_posts, b.num_topics' . ($read_status ? ',' . (!$user_info['is_guest'] ? ' 1 AS is_read' : '
			(IFNULL(lb.id_msg, 0) >= b.id_last_msg) AS is_read') : '') . '
		FROM {db_prefix}boards AS b' . ($read_status ? '
			LEFT JOIN {db_prefix}log_boards AS lb ON (lb.id_board = b.id_board AND lb.id_member = {int:current_member})' : '') . '
		WHERE {query_see_board}' . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
			AND b.id_board != {int:recycle_board}' : '') . '
			AND b.redirect = {string:blank_redirect}'. (isset($modSettings['subforums'][$_SERVER['SERVER_NAME']]) ? '
			AND b.id_cat IN ({array_int:cats})' : '') .'
		ORDER BY num_posts DESC
		LIMIT {int:limit_boards}',
		array(
			'recycle_board' => $modSettings['recycle_board'],
			'blank_redirect' => '',
			'limit_boards' => $limit,
			'current_member' => $user_info['id'],
			'cats' => isset($modSettings['subforums'][$_SERVER['SERVER_NAME']]) ? explode(',', $modSettings['subforums'][$_SERVER['SERVER_NAME']]['cats']) : array(
			),
		)
	);
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
		$request = $db->query('', '
			SELECT id_topic
			FROM {db_prefix}topics
			WHERE num_replies != {int:no_replies}' . ($modSettings['postmod_active'] ? '
				AND approved = {int:is_approved}' : '') . '
]]></search>
		<add><![CDATA[
		// SubForums
		$request = $db->query('', '
			SELECT id_topic
			FROM {db_prefix}topics
			WHERE num_replies != {int:no_replies}' . ($modSettings['postmod_active'] ? '
				AND approved = {int:is_approved}' : '') . '{subforums_see_board:id_board}
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
		$request = $db->query('', '
			SELECT id_topic
			FROM {db_prefix}topics
			WHERE num_views != {int:no_views}
]]></search>
		<add><![CDATA[
		// SubForums
		$request = $db->query('', '
			SELECT id_topic
			FROM {db_prefix}topics
			WHERE num_views != {int:no_views}{subforums_see_board:id_board}
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
		$request = $db->query('', '
			SELECT id_member_started, COUNT(*) AS hits
			FROM {db_prefix}topics' . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
			WHERE id_board != {int:recycle_board}' : '') . '
]]></search>
		<add><![CDATA[
		// SubForums
		$request = $db->query('', '
			SELECT id_member_started, COUNT(*) AS hits
			FROM {db_prefix}topics
			WHERE ' . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? 'id_board != {int:recycle_board}' : '1=1') . '{subforums_see_board:id_board}
]]></add>
	</operation>
</file>

<file name="SOURCEDIR/Logging.php">
	<operation>
		<search position="replace"><![CDATA[
	if (!empty($modSettings['who_enabled']))
	{
		$req = request();
		$serialized = $_GET + array('USER_AGENT' => $req->user_agent());
]]></search>
		<add><![CDATA[
	if (!empty($modSettings['who_enabled']))
	{
		// SubForums
		$serialized = $_GET + array('USER_AGENT' => $req->user_agent()) + array('subforums' => (!empty($modSettings['subforums'][$_SERVER['SERVER_NAME']]) ? array('host' => $_SERVER['SERVER_NAME'], 'name' => $modSettings['subforums'][$_SERVER['SERVER_NAME']]['name']) : ''));
]]></add>
	</operation>
</file>

<file name="SOURCEDIR/Subs.php">
	<operation>
		<search position="before"><![CDATA[
	$context['common_stats'] = array(
		'total_posts' => comma_format($modSettings['totalMessages']),
		'total_topics' => comma_format($modSettings['totalTopics']),
		'total_members' => comma_format($modSettings['totalMembers']),
		'latest_member' => $context['common_stats']['latest_member'],
	);
]]></search>
		<add><![CDATA[
	// SubForums
	if(isset($modSettings['subforums'][$_SERVER['SERVER_NAME']]))
	{
		$context['common_stats']['total_posts'] = comma_format($modSettings['subforums'][$_SERVER['SERVER_NAME']]['total_posts']);
		$context['common_stats']['total_topics'] = comma_format($modSettings['subforums'][$_SERVER['SERVER_NAME']]['total_topics']);
	}
]]></add>
	</operation>
</file>

<file name="SOURCEDIR/database/Db-mysql.class.php">
	<operation>
		<search position="replace"><![CDATA[
	public static function initiate($db_server, $db_name, $db_user, $db_passwd, $db_prefix, $db_options = array())
	{
		global $mysql_set_mode;

]]></search>
		<add><![CDATA[
	public static function initiate($db_server, $db_name, $db_user, $db_passwd, $db_prefix, $db_options = array())
	{
		global $mysql_set_mode;

		// include SubForums DB functions
		include_once(SOURCEDIR .'/SubForums/Subforums-DB.php');
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
	public function replacement__callback($matches)
	{
		global $db_callback, $user_info, $db_prefix;

		list ($values, $connection) = $db_callback;

		// Connection gone???  This should *never* happen at this point, yet it does :'(
		if (!is_object($connection))
			display_db_error();

		if ($matches[1] === 'db_prefix')
			return $db_prefix;

		if ($matches[1] === 'query_see_board')
			return $user_info['query_see_board'];

		if ($matches[1] === 'query_wanna_see_board')
			return $user_info['query_wanna_see_board'];
]]></search>
		<add><![CDATA[
	public function replacement__callback($matches)
	{
		global $db_callback, $user_info, $db_prefix;

		list ($query, $values, $connection) = $db_callback;

		// subforums db_callback.
		if(($subvar = SubForums_dbcallback($matches, $query)) !== null)
			return $subvar;
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
		// Only bother if there's something to replace.
		if (strpos($db_string, '{') !== false)
		{
			// This is needed by the callback function.
			$db_callback = array($db_values, $connection === null ? $this->_connection : $connection);
]]></search>
		<add><![CDATA[
		// Only bother if there's something to replace.
		if (strpos($db_string, '{') !== false)
		{
			// This is needed by the callback function.
			$db_callback = array($db_string, $db_values, $connection === null ? $this->_connection : $connection);
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
		if (empty($db_values['security_override']) && (!empty($db_values) || strpos($db_string, '{db_prefix}') !== false))
		{
			// Pass some values to the global space for use in the callback function.
			$db_callback = array($db_values, $connection);
]]></search>
		<add><![CDATA[
		if (empty($db_values['security_override']) && (!empty($db_values) || strpos($db_string, '{db_prefix}') !== false))
		{
			// Pass some values to the global space for use in the callback function.
			$db_callback = array($db_string, $db_values, $connection);
]]></add>
	</operation>
</file>

<file name="SOURCEDIR/database/Db-postgresql.class.php">
	<operation>
		<search position="replace"><![CDATA[
	public static function initiate($db_server, $db_name, $db_user, $db_passwd, $db_prefix, $db_options = array())
	{
]]></search>
		<add><![CDATA[
	public static function initiate($db_server, $db_name, $db_user, $db_passwd, $db_prefix, $db_options = array())
	{

	include_once(SOURCEDIR .'/SubForums/Subforums-DB.php');
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
	public function replacement__callback($matches)
	{
		global $db_callback, $user_info, $db_prefix;

		list ($values, $connection) = $db_callback;

		// Connection gone?
		if (!is_resource($connection))
			display_db_error();

		if ($matches[1] === 'db_prefix')
			return $db_prefix;

		if ($matches[1] === 'query_see_board')
			return $user_info['query_see_board'];

		if ($matches[1] === 'query_wanna_see_board')
			return $user_info['query_wanna_see_board'];
]]></search>
		<add><![CDATA[
	public function replacement__callback($matches)
	{
		global $db_callback, $user_info, $db_prefix;

		list ($query, $values, $connection) = $db_callback;

		// call the subforums db_callback.
		if(($subvar = SubForums_dbcallback($matches, $query)) !== null)
			return $subvar;
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
		// Only bother if there's something to replace.
		if (strpos($db_string, '{') !== false)
		{
			// This is needed by the callback function.
			$db_callback = array($db_values, $connection === null ? $this->_connection : $connection);
]]></search>
		<add><![CDATA[
		// Only bother if there's something to replace.
		if (strpos($db_string, '{') !== false)
		{
			// This is needed by the callback function.
			$db_callback = array($db_string, $db_values, $connection === null ? $this->_connection : $connection);
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
		if (empty($db_values['security_override']) && (!empty($db_values) || strpos($db_string, '{db_prefix}') !== false))
		{
			// Pass some values to the global space for use in the callback function.
			$db_callback = array($db_values, $connection);
]]></search>
		<add><![CDATA[
		if (empty($db_values['security_override']) && (!empty($db_values) || strpos($db_string, '{db_prefix}') !== false))
		{
			// Pass some values to the global space for use in the callback function.
			$db_callback = array($db_string, $db_values, $connection);
]]></add>
	</operation>
</file>

<file name="SUBSDIR/MembersOnline.subs.php">
	<operation>
		<search position="replace"><![CDATA[
	// Load the users online right now.
	$request = $db->query('', '
		SELECT
			lo.id_member, lo.log_time, lo.id_spider, mem.real_name, mem.member_name, mem.show_online,
]]></search>
		<add><![CDATA[
	// Load the users online right now.
	$request = $db->query('', '
		SELECT
			lo.id_member, lo.log_time, lo.id_spider, lo.url, mem.real_name, mem.member_name, mem.show_online,
]]></add>
	</operation>

	<operation>
		<search position="replace"><![CDATA[
	while ($row = $db->fetch_assoc($request))
	{
		if (empty($row['real_name']))
		{
			// Do we think it's a spider?
			if ($row['id_spider'] && isset($spiders[$row['id_spider']]))
]]></search>
		<add><![CDATA[
	while ($row = $db->fetch_assoc($request))
	{
		// Subforums
		$subf = unserialize($row['url']);
		if(isset($subf['subforums']) && SubforumsAllocator('checkurl', $subf['subforums']) != $_SERVER['SERVER_NAME'])
			continue;
			
		if (empty($row['real_name']))
		{
			// Do we think it's a spider?
			if ($row['id_spider'] && isset($spiders[$row['id_spider']]))
]]></add>
	</operation>
</file>

<file name="CONTROLLERDIR/Who.controller.php">
	<operation>
		<search position="before"><![CDATA[
		// Put it in the context variables.
		foreach ($context['members'] as $i => $member)
		{
			if ($member['id'] != 0)
				$member['id'] = loadMemberContext($member['id']) ? $member['id'] : 0;
]]></search>
		<add><![CDATA[

			// check for Subforums
			if(isset($member['query']['subforums']) && SubforumsAllocator('checkurl', $member['query']['subforums']) != $_SERVER['SERVER_NAME'])
			{
				unset($context['members'][$i]);
				continue;
			}
]]></add>
	</operation>
</file>

<file name="SUBSDIR/Who.subs.php">
	<operation>
		<search position="before"><![CDATA[
	foreach ($url_list as $k => $url)
	{
		// Get the request parameters..
		$actions = @unserialize($url[0]);
		if ($actions === false)
			continue;
]]></search>
		<add><![CDATA[
		// check for Subforums
		if(isset($actions['subforums']) && SubforumsAllocator('checkurl', $actions['subforums']) != $_SERVER['SERVER_NAME'])
			continue;
]]></add>
	</operation>
</file>

<file name="THEMEDIR/Login.template.php">
	<operation>
		<search position="replace"><![CDATA[
	<div class="login" id="maintenance_mode">
		<h2 class="category_header">', $context['title'], '</h2>
		<p class="description flow_auto">
]]></search>
		<add><![CDATA[
	<div class="login cat_bar subforum_hide" id="maintenance_mode">
		<h2 class="category_header">', $context['title'], '</h2>
		<p class="description flow_auto subforum_hide">
]]></add>
	</operation>
</file>

</modification>